<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPTV Oynatıcı ve Kontrol Edici</title>
  <link href="https://vjs.zencdn.net/7.14.3/video-js.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 3fr;
      gap: 20px;
    }
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .channel-section {
      background: white;
      border-radius: 5px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .player-section {
      background: white;
      border-radius: 5px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #333;
    }
    #channelList {
      max-height: 600px;
      overflow-y: auto;
    }
    .channel-item {
      padding: 10px;
      margin: 5px 0;
      background: #f9f9f9;
      border-left: 3px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }
    .channel-item:hover {
      background: #efefef;
      border-left-color: #007bff;
    }
    .search-container {
      margin-bottom: 15px;
    }
    #searchInput {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .video-js {
      width: 100%;
      height: 400px;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    #m3uForm {
      margin-top: 20px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 5px;
    }
    .btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="channel-section">
      <h2>Kanallar</h2>
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="Kanal ara...">
      </div>
      <div id="channelList">
        <p class="loading">Kanallar yükleniyor...</p>
      </div>
      
      <div id="m3uForm">
        <h3>M3U Listesi Ekle</h3>
        <input type="text" id="m3uUrl" placeholder="M3U URL giriniz" style="width: 100%; margin-bottom: 10px; padding: 8px;">
        <button class="btn" onclick="loadM3uPlaylist()">Listeyi Yükle</button>
      </div>
    </div>
    
    <div class="player-section">
      <h2>Video Oynatıcı</h2>
      <video id="videoPlayer" class="video-js vjs-default-skin vjs-big-play-centered">
        <p class="vjs-no-js">
          Video oynatıcı çalışmıyor. Lütfen JavaScript'i etkinleştirin.
        </p>
      </video>
      
      <div id="streamInfo" style="margin-top: 15px;">
        <h3>Akış Bilgisi</h3>
        <p>Henüz bir kanal seçilmedi.</p>
      </div>
      
      <div id="streamCheck" style="margin-top: 15px;">
        <h3>Akış Durumu Kontrolü</h3>
        <p>Kanal seçildiğinde, akış durumu burada gösterilecek.</p>
      </div>
    </div>
  </div>

  <script src="https://vjs.zencdn.net/7.14.3/video.min.js"></script>
  <script>
    // Global değişkenler
    let player;
    let channels = [];
    
    // Sayfa yüklendiğinde çalışacak kodlar
    document.addEventListener('DOMContentLoaded', async function() {
      // Video.js player'ı başlat
      initializePlayer();
      
      // Kanalları yükle
      await fetchChannels();
      
      // Arama kutusuna event listener ekle
      document.getElementById('searchInput').addEventListener('input', filterChannels);
    });
    
    // Video player'ı başlat
    function initializePlayer() {
      // Önce mevcut player instance'ını kontrol edelim ve varsa temizleyelim
      if (videojs.getPlayers()['videoPlayer']) {
        videojs.getPlayers()['videoPlayer'].dispose();
      }
      
      // Yeni player oluştur
      player = videojs('videoPlayer', {
        controls: true,
        autoplay: false,
        preload: 'auto'
      });
    }
    
	async function fetchChannels() {
	  try {
		const response = await fetch("https://corsproxy.io/?https%3A%2F%2Fvavoo.to%2Fchannels", {
		  headers: {
			'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
			'Accept': 'application/json'
		  }
		});
		
		if (!response.ok) {
		  throw new Error(`HTTP hata: ${response.status}`);
		}
		
		return await response.json();
	  } catch (error) {
		console.error("Kanallar yüklenirken hata oluştu:", error);
		throw error;
	  }
	}
    
    // Kanalları görüntüle
    function displayChannels(channelList) {
      const channelListElement = document.getElementById('channelList');
      
      if (channelList.length === 0) {
        channelListElement.innerHTML = '<p>Kanal bulunamadı.</p>';
        return;
      }
      
      let html = '';
      
      channelList.forEach(channel => {
        html += `<div class="channel-item" onclick="playChannel('${channel.url}', '${channel.name}')">
                  ${channel.name}
                </div>`;
      });
      
      channelListElement.innerHTML = html;
    }
    
    // Kanalları filtrele
    function filterChannels() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm) {
        displayChannels(channels);
        return;
      }
      
      const filteredChannels = channels.filter(channel => 
        channel.name.toLowerCase().includes(searchTerm)
      );
      
      displayChannels(filteredChannels);
    }
    
    // Kanalı oynat
    function playChannel(url, name) {
      // Akış durumunu kontrol et
      checkStreamStatus(url);
      
      // Player kaynağını güncelle
      player.src({
        src: url,
        type: 'application/x-mpegURL'
      });
      
      // Player'ı başlat
      player.play();
      
      // Akış bilgisini güncelle
      document.getElementById('streamInfo').innerHTML = `
        <h3>Akış Bilgisi</h3>
        <p><strong>Kanal:</strong> ${name}</p>
        <p><strong>URL:</strong> ${url}</p>
      `;
    }
    
    // Akış durumunu kontrol et
    async function checkStreamStatus(url) {
      const streamCheckElement = document.getElementById('streamCheck');
      streamCheckElement.innerHTML = '<h3>Akış Durumu Kontrolü</h3><p>Kontrol ediliyor...</p>';
      
      try {
        const response = await fetch(url, { method: 'HEAD', timeout: 5000 });
        
        if (response.ok) {
          streamCheckElement.innerHTML = `
            <h3>Akış Durumu Kontrolü</h3>
            <p style="color: green;">✓ Akış aktif ve erişilebilir.</p>
            <p>Durum Kodu: ${response.status}</p>
          `;
        } else {
          streamCheckElement.innerHTML = `
            <h3>Akış Durumu Kontrolü</h3>
            <p style="color: orange;">⚠ Akış mevcut ama hata kodu döndü.</p>
            <p>Durum Kodu: ${response.status}</p>
          `;
        }
      } catch (error) {
        streamCheckElement.innerHTML = `
          <h3>Akış Durumu Kontrolü</h3>
          <p style="color: red;">✗ Akışa erişilemiyor.</p>
          <p>Hata: ${error.message}</p>
        `;
      }
    }
    
    // M3U listesini yükle
    async function loadM3uPlaylist() {
      const m3uUrl = document.getElementById('m3uUrl').value.trim();
      
      if (!m3uUrl) {
        alert('Lütfen geçerli bir M3U URL giriniz.');
        return;
      }
      
      try {
        // CORS proxy kullanarak M3U içeriğini çekelim
        const corsProxy = 'https://corsproxy.io/?';
        const response = await fetch(corsProxy + encodeURIComponent(m3uUrl));
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const m3uContent = await response.text();
        const parsedChannels = parseM3U(m3uContent);
        
        // Yeni kanalları ekle
        channels = [...channels, ...parsedChannels];
        displayChannels(channels);
        
        alert('M3U listesi başarıyla yüklendi!');
      } catch (error) {
        console.error('M3U listesi yüklenirken hata oluştu:', error);
        alert(`M3U listesi yüklenemedi: ${error.message}`);
      }
    }
    
    // M3U içeriğini ayrıştır
    function parseM3U(content) {
      const lines = content.split('\n');
      const parsedChannels = [];
      let currentChannel = {};
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line.startsWith('#EXTINF:')) {
          // İsim bilgisini çıkar
          const nameMatch = line.match(/tvg-name="([^"]*)"/) || line.match(/,(.*)$/);
          currentChannel.name = nameMatch ? nameMatch[1] : `Kanal ${parsedChannels.length + 1}`;
        } else if (line.startsWith('http') || line.startsWith('rtmp')) {
          // URL satırı
          currentChannel.url = line;
          parsedChannels.push({...currentChannel});
          currentChannel = {};
        }
      }
      
      return parsedChannels;
    }
  </script>
</body>
</html>
